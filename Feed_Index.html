<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏¢‡∏≤ (Premium Dark)</title>
<link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3069/3069186.png">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
  body { font-family: 'Kanit', sans-serif; background-color: #1a202c; -webkit-tap-highlight-color: transparent; padding-bottom: 80px; }
  
  /* Background Header Image */
  .header-bg { 
    background-image: url("https://drive.google.com/uc?export=view&id=1LUFEgZZOO2yOSP_zJ_GHxCCY5XiFVvvH"); 
    background-size: cover; background-position: center 30%; 
    background-repeat: no-repeat; position: absolute; 
    top: 0; left: 0; right: 0; bottom: 0; 
    background-color: rgba(26, 32, 44, 0.7); background-blend-mode: multiply; 
  }
  
  .loader { border: 5px solid #f3f3f3; border-top: 5px solid #f59e0b; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  .tab-btn.active { background-color: #f59e0b; color: #1a202c; box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.3); }
  .card-tap-effect:active { transform: scale(0.98); transition: transform 0.1s ease-out; }
  
  .qty-input { width: 80px; text-align: center; padding: 6px; border: 1px solid #4a5568; border-radius: 6px; font-weight: bold; background-color: #2d3748; color: #f7fafc; }
  
  /* SweetAlert Dark Theme Overrides */
  .swal2-popup { background: #2d3748 !important; color: #f7fafc !important; }
  .swal2-title, .swal2-html-container { color: #f7fafc !important; }
  .swal2-input, .swal2-select { background-color: #1a202c !important; color: #f7fafc !important; border-color: #4a5568 !important; }
  .swal2-select option { color: #1a202c !important; background-color: #f7fafc !important; }
  .swal2-confirm { background-color: #f59e0b !important; color: #1a202c !important; }
  .swal2-cancel { background-color: #4a5568 !important; color: #f7fafc !important; }
  
  .stock-in-row { background-color: #1a202c !important; border-color: #4a5568 !important; }
  
  /* Home Button Style */
  .home-btn {
    position: absolute; top: 15px; left: 15px; z-index: 50;
    background: rgba(255,255,255,0.2); color: white;
    width: 40px; height: 40px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(5px); text-decoration: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  }
</style>
</head>
<body>

<div id="loading-screen" class="fixed inset-0 bg-black bg-opacity-70 flex flex-col justify-center items-center z-50 hidden">
  <div class="loader mb-4"></div>
  <p class="text-white font-bold"> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•... </p>
</div>

<div class="w-full bg-white min-h-screen shadow-xl relative bg-slate-900">

  <header class="bg-gray-800 text-white p-6 rounded-b-3xl shadow-2xl shadow-slate-900/50 mb-6 relative overflow-hidden h-48 flex items-center justify-center">
    <div class="header-bg"></div>
    
    <? var url = getAppUrl(); ?>
    <a href="<?= url ?>" class="home-btn card-tap-effect">
      <i class="material-icons">home</i>
    </a>

    <div class="relative z-10 text-center">
      <h1 class="text-3xl font-extrabold text-white [text-shadow:_0_2px_4px_rgb(0_0_0_/_40%)]">üê∑ ‡∏ô‡∏¥‡∏û‡∏ô‡∏ò‡πå‡∏ü‡∏≤‡∏£‡πå‡∏°</h1>
      <div class="mt-2 bg-gray-900/50 py-1 px-4 rounded-xl border border-gray-700 inline-block shadow-inner backdrop-blur-sm">
        <div id="clock-time" class="text-2xl font-mono font-extrabold text-amber-400">00:00:00</div>
        <div id="clock-date" class="text-[10px] text-gray-400"> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... </div>
      </div>
      <button onclick="openManual()" class="absolute top-[-40px] right-[-10px] bg-gray-700/50 hover:bg-gray-700/80 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold shadow-xl transition card-tap-effect">?</button>
    </div>
  </header>

  <div class="flex justify-center gap-2 px-4 mb-6">
    <button onclick="changeTab('main')" id="tab-main" class="tab-btn active flex-1 py-2 rounded-xl font-bold bg-amber-500 text-slate-900 shadow-lg transition-all card-tap-effect">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    <button onclick="changeTab('report')" id="tab-report" class="tab-btn flex-1 py-2 rounded-xl font-bold bg-gray-700 text-gray-300 shadow-md transition-all card-tap-effect">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
    <button onclick="changeTab('settings')" id="tab-settings" class="tab-btn flex-1 py-2 rounded-xl font-bold bg-gray-700 text-gray-300 shadow-md transition-all card-tap-effect">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
  </div>

  <div id="page-main" class="px-4">
    <div class="bg-gray-800 p-4 rounded-2xl shadow-xl shadow-gray-900/50 mb-6">
      <h2 class="text-amber-400 font-bold mb-3">‚ö°Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ú‡∏™‡∏°</h2>
      <div class="grid grid-cols-2 gap-3">
        <button onclick="openFlexibleMix('‡∏´‡∏°‡∏π‡πÄ‡∏•‡πá‡∏Å')" class="card-tap-effect bg-gray-700 p-3 rounded-xl text-gray-200 font-bold shadow-md border border-gray-600"> ‡∏´‡∏°‡∏π‡πÄ‡∏•‡πá‡∏Å </button>
        <button onclick="openFlexibleMix('‡∏´‡∏°‡∏π‡∏£‡∏∏‡πà‡∏ô')" class="card-tap-effect bg-gray-700 p-3 rounded-xl text-gray-200 font-bold shadow-md border border-gray-600"> ‡∏´‡∏°‡∏π‡∏£‡∏∏‡πà‡∏ô </button>
        <button onclick="openFlexibleMix('‡∏´‡∏°‡∏π‡∏Ç‡∏∏‡∏ô')" class="card-tap-effect bg-gray-700 p-3 rounded-xl text-gray-200 font-bold shadow-md border border-gray-600"> ‡∏´‡∏°‡∏π‡∏Ç‡∏∏‡∏ô </button>
        <button onclick="openFlexibleMix('‡πÅ‡∏°‡πà‡∏´‡∏°‡∏π')" class="card-tap-effect bg-gray-700 p-3 rounded-xl text-gray-200 font-bold shadow-md border border-gray-600"> ‡πÅ‡∏°‡πà‡∏´‡∏°‡∏π </button>
      </div>
    </div>

    <div class="grid grid-cols-3 gap-2 mb-6">
      <button onclick="openStockInModal()" class="card-tap-effect bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-emerald-500/50">üì• ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</button>
      <button onclick="openAdjustModal()" class="card-tap-effect bg-amber-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-amber-500/50">üõ† ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</button>
      <button onclick="openEventModal()" class="card-tap-effect bg-purple-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-purple-500/50">üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
    </div>

    <h3 class="font-bold text-gray-300 mb-3 border-l-4 border-amber-500 pl-2">üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3>
    <div id="stock-display-area" class="space-y-4 pb-10"></div>
  </div>

  <div id="page-report" class="px-4 hidden">
    <div class="bg-gray-800 p-5 rounded-2xl shadow-xl shadow-gray-900/50 mb-4 border border-gray-700">
      <h3 class="font-bold text-center text-gray-200 mb-4"> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ </h3>
      <div class="grid grid-cols-2 gap-4 text-center">
        <div class="bg-gray-700 p-4 rounded-xl shadow-md"><div class="text-xs text-amber-500 font-bold"> ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° </div><div id="report-cost" class="text-2xl font-bold text-amber-300 my-1">0</div><div class="text-xs text-gray-400"> ‡∏ö‡∏≤‡∏ó </div></div>
        <div class="bg-gray-700 p-4 rounded-xl shadow-md"><div class="text-xs text-green-500 font-bold"> ‡∏ú‡∏™‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß </div><div id="report-count" class="text-2xl font-bold text-green-300 my-1">0</div><div class="text-xs text-gray-400"> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á </div></div>
      </div>
    </div>
    <div class="bg-gray-800 p-4 rounded-2xl shadow-xl shadow-gray-900/50 border border-gray-700 mb-4"><h4 class="font-bold text-gray-300 mb-2 text-sm">üç∞ ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</h4><div class="h-48 flex justify-center"><canvas id="chart-mat"></canvas></div></div>
    <div class="bg-gray-800 p-4 rounded-2xl shadow-xl shadow-gray-900/50 border border-gray-700 mb-4"><h4 class="font-bold text-gray-300 mb-2 text-sm">üìä ‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏π‡∏ï‡∏£</h4><div class="h-48"><canvas id="chart-formula"></canvas></div></div>
    <div class="bg-gray-800 p-4 rounded-2xl shadow-xl shadow-gray-900/50 border border-gray-700"><h4 class="font-bold text-gray-300 mb-3 border-b border-gray-700 pb-2">üìù ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4><div id="report-history-list" class="space-y-2 text-sm"></div></div>
  </div>

  <div id="page-settings" class="px-4 hidden">
    <div class="space-y-4 pb-10">
      <button onclick="loadAllData(true)" class="w-full py-3 bg-amber-500 text-gray-900 rounded-xl shadow-lg font-bold card-tap-effect">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <div class="bg-gray-800 p-5 rounded-2xl shadow-xl shadow-gray-900/50 border border-gray-700">
        <h3 class="font-bold mb-4 text-gray-200"> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà </h3>
        <div class="flex gap-3"><button onclick="addNewItemModal('Mat')" class="flex-1 bg-green-700 text-white py-3 rounded-xl font-bold hover:bg-green-600 card-tap-effect"> ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö </button><button onclick="addNewItemModal('Sup')" class="flex-1 bg-teal-700 text-white py-3 rounded-xl font-bold hover:bg-teal-600 card-tap-effect"> ‡∏¢‡∏≤/‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô </button></div>
      </div>
    </div>
  </div>
</div>

<script>
// --- GLOBAL VARS ---
var appData = {}; var currentMixData = {}; var chartInstance1 = null; var chartInstance2 = null;
const MANUAL_URL = 'https://docs.google.com/document/d/1dnhD3G4z_O5LhIGDU7Yk-oqfvWR-bOqUSPl82wR4FyY/edit?usp=sharing';
const ADJUST_CATEGORIES = [{ code: 'WASTE', label: '‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢ / ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ üóëÔ∏è' }, { code: 'LOSS', label: '‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢ / ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏• üíß' }, { code: 'FARM_USE', label: '‡πÉ‡∏ä‡πâ‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡∏ü‡∏≤‡∏£‡πå‡∏° ü•©' }, { code: 'COUNT_ERROR', label: '‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î üî¢' }, { code: 'OTHER', label: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏)' }];
const EVENT_CATEGORIES = [{ code: 'RECEIPT', label: '‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤/‡∏ö‡∏¥‡∏•‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á üßæ' }, { code: 'PIG_HEALTH', label: '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏°‡∏π/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û üê∑' }, { code: 'MATERIAL_ISSUE', label: '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢/‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‚ö†Ô∏è' }, { code: 'MAINTENANCE', label: '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á/‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ üîß' }, { code: 'GENERAL', label: '‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ üñºÔ∏è' }];

// --- INIT ---
window.onload = function() { loadAllData(); startClock(); };

function openManual() { Swal.fire({ title: 'üìñ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏¢‡πà‡∏≠', html: `<div class="text-left text-sm text-gray-400 space-y-3 px-2"><div class="p-3 bg-gray-700 border border-gray-600 rounded"><b>1. ‡∏ú‡∏™‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</b> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏π‡∏ï‡∏£ > ‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≠‡∏î > ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div><div class="p-3 bg-gray-700 border border-gray-600 rounded"><b>2. ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤:</b> ‡∏Å‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ > ‡∏Å‡∏î +‡πÄ‡∏û‡∏¥‡πà‡∏° > ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á > ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div><div class="text-center mt-4"><a href="${MANUAL_URL}" target="_blank" class="btn bg-amber-500 text-gray-900 py-2 px-4 rounded shadow">üìÑ ‡∏≠‡πà‡∏≤‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°</a></div></div>`, showConfirmButton: false, showCloseButton: true }); }
function startClock() { function update() { const now = new Date(); const opts = { timeZone: 'Asia/Bangkok' }; document.getElementById('clock-time').innerText = now.toLocaleTimeString('th-TH', {...opts, hour:'2-digit', minute:'2-digit', second:'2-digit'}); document.getElementById('clock-date').innerText = now.toLocaleDateString('th-TH', {...opts, weekday:'long', day:'numeric', month:'long', year:'numeric'}); } update(); setInterval(update, 1000); }
function showLoading(isShow) { document.getElementById('loading-screen').classList.toggle('hidden', !isShow); }

function changeTab(tabName) { 
  ['main', 'report', 'settings'].forEach(p => { 
    document.getElementById('page-' + p).classList.add('hidden'); 
    document.getElementById('tab-' + p).classList.remove('active', 'bg-amber-500', 'text-slate-900'); 
    document.getElementById('tab-' + p).classList.add('bg-gray-700', 'text-gray-300'); 
  }); 
  document.getElementById('page-' + tabName).classList.remove('hidden'); 
  var btn = document.getElementById('tab-' + tabName); 
  btn.classList.remove('bg-gray-700', 'text-gray-300'); 
  btn.classList.add('active', 'bg-amber-500', 'text-slate-900'); 
  if(tabName === 'report') loadReport(); 
}

// ==========================================
// üîó CONNECT TO BACKEND (feed_...)
// ==========================================

function loadAllData(notify) { 
  showLoading(true); 
  google.script.run.withSuccessHandler(function(data) { 
    showLoading(false); 
    if (data.error) return Swal.fire('Error', data.error, 'error'); 
    appData = data; 
    renderStock(); 
    if(notify) Swal.fire({icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß' , timer: 1000, showConfirmButton: false}); 
  }).feed_getInitialData(); 
}

function renderStock() {
  var html = '';
  if(appData.stock) { 
    html += '<div class="bg-gray-800 p-4 rounded-xl shadow-xl shadow-gray-900/50 mb-4"><h4 class="font-bold text-amber-400 text-sm mb-4 border-b border-gray-700 pb-2">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏´‡∏•‡∏±‡∏Å</h4>'; 
    appData.stock.forEach(item => { 
      var isLow = (item.min > 0 && item.current <= item.min); 
      var isCrit = (item.current <= item.min / 2); 
      var maxVal = item.min > 0 ? Math.max(item.current, item.min) * 1.2 : item.current; 
      var percent = maxVal > 0 ? (item.current / maxVal) * 100 : 0; 
      var barColor = isCrit ? 'bg-red-600' : (isLow ? 'bg-orange-500' : 'bg-green-500'); 
      var barText = isCrit ? '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï' : (isLow ? '‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥' : '‡∏õ‡∏Å‡∏ï‡∏¥'); 
      html += `<div class="py-2 border-b border-gray-700 last:border-0"><div class="flex justify-between items-center mb-1"><span class="text-gray-100 font-semibold">${item.name} ${isLow ? '‚ö†Ô∏è' : ''}</span><span class="font-bold text-lg ${isLow ? 'text-red-400' : 'text-green-400'}">${item.current.toLocaleString()} <small class="text-gray-400 text-sm">${item.unit}</small></span></div><div class="w-full bg-gray-700 rounded-full h-2.5"><div class="${barColor} h-2.5 rounded-full" style="width: ${percent}%"></div></div><div class="text-[10px] text-gray-500 mt-1 flex justify-between"><span>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥: ${item.min} ${item.unit}</span><span class="${isLow ? 'text-red-400' : 'text-gray-400'}">${barText}</span></div></div>`; 
    }); 
    html += '</div>'; 
  }
  if(appData.supplements) { 
    html += '<div class="bg-gray-800 p-4 rounded-xl shadow-xl shadow-gray-900/50"><h4 class="font-bold text-teal-400 text-sm mb-4 border-b border-gray-700 pb-2">‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô/‡∏¢‡∏≤</h4>'; 
    appData.supplements.forEach(item => { 
      html += `<div class="flex justify-between py-2 border-b border-gray-700 last:border-0"><span class="text-gray-100">${item.name}</span><span class="font-bold text-teal-400">${item.current.toFixed(1)} <small class="text-gray-400 text-sm">${item.unit}</small></span></div>`; 
    }); 
    html += '</div>'; 
  }
  document.getElementById('stock-display-area').innerHTML = html;
}

function openFlexibleMix(formulaName) { 
  showLoading(true); 
  google.script.run.withSuccessHandler(function(data) { 
    showLoading(false); 
    if (data.error) return Swal.fire('Error', data.error, 'error'); 
    currentMixData = data; 
    showMixPopup(); 
  }).feed_getMixingPrepData(formulaName); 
}

function showMixPopup() { 
  var html = '<div class="text-left text-sm overflow-y-auto max-h-[60vh]"><div class="bg-gray-700 text-amber-400 font-bold p-2 rounded mb-2">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏´‡∏•‡∏±‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</div><table class="w-full mb-4">' ; 
  currentMixData.mainItems.forEach((item, idx) => { 
    if(item.amount > 0 || item.currentStock > 0) html += `<tr class="border-b border-gray-600"><td class="py-2 font-bold text-gray-200">${item.name} <div class="text-xs text-gray-400">‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.currentStock}</div></td><td class="text-right"><input type="number" id="input-main-${idx}" class="qty-input" value="${item.amount}" onchange="updateAmount('main', ${idx}, this.value)"></td></tr>`; 
  }); 
  html += '</table><div class="bg-gray-700 text-teal-400 font-bold p-2 rounded mb-2 flex justify-between"><span>‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô (Auto)</span></div><table class="w-full mb-4">' ; 
  currentMixData.supplementItems.forEach((item) => { 
    if(item.amount > 0) html += `<tr class="border-b border-gray-600 bg-gray-800"><td class="py-2 pl-2 text-gray-200">${item.name}</td><td class="text-right pr-2 font-bold text-teal-400">${item.amount} ${item.unit}</td></tr>`; 
  }); 
  html += '</table><div class="bg-gray-700 p-3 rounded text-right"><div>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: <span id="sum-cost" class="text-amber-400 font-bold text-xl">0</span> ‡∏ö.</div><div>‡∏ô‡∏ô.: <span id="sum-weight" class="text-gray-300 font-bold">0</span> ‡∏Å‡∏Å.</div></div></div>' ; 
  Swal.fire({ title: `‡∏™‡∏π‡∏ï‡∏£: ${currentMixData.formulaName}`, html: html, width: '600px', showCancelButton: true, confirmButtonText: '‚úÖ ‡∏ú‡∏™‡∏°' , confirmButtonColor: '#10b981', didOpen: () => recalculate() }).then((r) => { if (r.isConfirmed) submitMix(); }); 
}

function updateAmount(type, idx, val) { if (type === 'main') currentMixData.mainItems[idx].amount = parseFloat(val) || 0; recalculate(); }

function recalculate() { 
  var cost = 0, weight = 0; 
  currentMixData.mainItems.forEach(i => { cost += i.amount*i.pricePerUnit; weight += i.amount*i.weightPerUnit; }); 
  currentMixData.supplementItems.forEach(i => { cost += i.amount*i.pricePerUnit; if(i.unit=== '‡∏Å‡∏Å.' ) weight += i.amount; }); 
  document.getElementById('sum-cost').innerText = cost.toLocaleString(undefined,{maximumFractionDigits:0}); 
  document.getElementById('sum-weight').innerText = weight.toLocaleString(undefined,{maximumFractionDigits:2}); 
}

function submitMix() { 
  showLoading(true); 
  google.script.run.withSuccessHandler(res => { 
    showLoading(false); 
    if(res.error) Swal.fire('Error', res.error, 'error'); 
    else { appData = res; renderStock(); Swal.fire( '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' , '‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß' , 'success'); } 
  }).feed_recordCustomMixing(currentMixData); 
}

// ==========================================
// üì• STOCK IN SYSTEM (+ Invoice Image + Auto Price)
// ==========================================
function openStockInModal() { 
  var html = `
    <div class="text-left space-y-3">
      <div><label class="block text-gray-400 text-xs mb-1">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</label><input type="text" id="si-supplier" class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤"></div>
      
      <div>
        <label class="block text-gray-400 text-xs mb-1">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
        <div class="flex items-center gap-2">
           <label class="flex-1 bg-gray-700 hover:bg-gray-600 text-white p-2 rounded cursor-pointer text-center text-sm border border-gray-600 transition">
              <i class="material-icons text-base align-middle mr-1">camera_alt</i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ
              <input type="file" id="si-invoice-img" class="hidden" accept="image/*" onchange="previewInvoice(this)">
           </label>
           <div id="img-preview" class="hidden h-10 w-10 bg-cover bg-center rounded border border-gray-500"></div>
           <span id="img-name" class="text-xs text-gray-500 truncate max-w-[120px]"></span>
        </div>
      </div>

      <div>
        <div class="flex justify-between items-center mb-1"><span class="font-bold text-gray-200 text-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span><button onclick="addStockInRow()" class="bg-amber-500 text-gray-900 px-2 py-1 rounded text-xs font-bold card-tap-effect">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button></div>
        <div class="flex text-xs text-gray-500 px-2 mb-1"><div class="w-2/5">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div><div class="w-1/5 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div><div class="w-1/5 text-center">‡∏´‡∏ô‡πà‡∏ß‡∏¢</div><div class="w-1/5 text-center">‡∏£‡∏≤‡∏Ñ‡∏≤</div></div>
        <div id="stock-in-container" class="space-y-2 max-h-[30vh] overflow-y-auto p-1 bg-gray-800/50 rounded"></div>
      </div>
      <div class="bg-gray-700 p-2 rounded text-right"><span class="text-gray-300 text-xs">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</span><span id="si-grand-total" class="text-amber-400 font-bold text-xl ml-2">0.00</span><span class="text-xs text-gray-400">‡∏ö‡∏≤‡∏ó</span></div>
    </div>`; 

  Swal.fire({ title: 'üì• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤', html: html, width: '650px', showCancelButton: true, confirmButtonText: 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', confirmButtonColor: '#10b981', 
    didOpen: () => { addStockInRow(); }, 
    preConfirm: () => { 
      var supplier = document.getElementById('si-supplier').value;
      if(!supplier) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤'); return false; }
      
      var rows = document.querySelectorAll('.stock-in-row'); var validItems = []; var grandTotal = 0;
      rows.forEach((row) => { 
        var name = row.querySelector('.si-name').value; var amt = parseFloat(row.querySelector('.si-amt').value); var unitType = row.querySelector('.si-unit').value; 
        var unitLabel = row.querySelector('.si-unit').options[row.querySelector('.si-unit').selectedIndex].text; var price = parseFloat(row.querySelector('.si-price').value) || 0;
        if (name && amt > 0) { validItems.push({ name: name, amount: amt, unitType: unitType, unit: unitLabel, price: price }); grandTotal += (amt * price); }
      }); 
      if (validItems.length === 0) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); return false; } 

      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      var fileInput = document.getElementById('si-invoice-img');
      var p = Promise.resolve(null);
      if (fileInput.files.length > 0) {
        p = new Promise((resolve) => {
          var reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result); // ‡∏™‡πà‡∏á Base64
          reader.readAsDataURL(fileInput.files[0]);
        });
      }

      return p.then(imgBase64 => {
        return { items: validItems, supplier: supplier, grandTotal: grandTotal, invoiceImage: imgBase64 }; 
      });
    } 
  }).then((r) => { 
    if (r.isConfirmed) { showLoading(true); google.script.run.withSuccessHandler(afterAction).feed_recordBatchStockIn(r.value); } 
  }); 
}

function previewInvoice(input) {
  if (input.files && input.files[0]) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var pv = document.getElementById('img-preview');
      pv.style.backgroundImage = `url('${e.target.result}')`;
      pv.classList.remove('hidden');
      document.getElementById('img-name').innerText = input.files[0].name;
    }
    reader.readAsDataURL(input.files[0]);
  }
}

function addStockInRow() { 
  var c = document.getElementById('stock-in-container'); var opts = '<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>'; 
  if (appData.stock) { opts += '<optgroup label="‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö">'; appData.stock.forEach(x => opts += `<option value="${x.name}" data-type="mat" class="text-gray-900">${x.name}</option>`); opts += '</optgroup>'; } 
  if (appData.supplements) { opts += '<optgroup label="‡∏¢‡∏≤/‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô">'; appData.supplements.forEach(x => opts += `<option value="${x.name}" data-type="sup" class="text-gray-900">${x.name}</option>`); opts += '</optgroup>'; } 
  var div = document.createElement('div'); div.className = 'stock-in-row flex gap-2 items-center bg-gray-900 p-2 rounded border border-gray-700'; 
  div.innerHTML = `<select class="si-name w-2/5 p-1 border rounded text-xs bg-gray-800 text-gray-200" onchange="updateUnitOptions(this)">${opts}</select><input type="number" class="si-amt w-1/5 p-1 border rounded text-xs text-center bg-gray-800 text-gray-200" placeholder="0" oninput="calculateTotal()"><select class="si-unit w-1/5 p-1 border rounded text-xs bg-gray-800 text-gray-200"><option value="std">-</option></select><input type="number" step="0.01" class="si-price w-1/5 p-1 border rounded text-xs text-right bg-gray-800 text-gray-200 text-amber-300" placeholder="‡∏ø0.00" oninput="calculateTotal()"><button onclick="this.parentElement.remove(); calculateTotal();" class="text-red-500 font-bold px-1">√ó</button>`; 
  c.appendChild(div); 
}

window.updateUnitOptions = function(selectElement) { 
  var row = selectElement.closest('.stock-in-row'); var unitSel = row.querySelector('.si-unit'); var priceInput = row.querySelector('.si-price');
  var selectedName = selectElement.value; var selectedOption = selectElement.options[selectElement.selectedIndex]; var type = selectedOption.getAttribute('data-type'); 
  
  // ‚ú® Auto-fill Price (‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å appData.prices ‡∏°‡∏≤‡πÉ‡∏™‡πà)
  var defaultPrice = 0; 
  if (appData.prices && appData.prices[selectedName]) { defaultPrice = appData.prices[selectedName]; } 
  priceInput.value = defaultPrice; 

  if (type === 'mat') { unitSel.innerHTML = '<option value="sack">‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</option>'; } else { unitSel.innerHTML = `<option value="pack">‡∏ñ‡∏∏‡∏á (‡∏Ñ‡∏π‡∏ì‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)</option><option value="kg">‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°</option>`; } 
  calculateTotal();
}

function calculateTotal() {
  var rows = document.querySelectorAll('.stock-in-row'); var total = 0;
  rows.forEach(r => { var amt = parseFloat(r.querySelector('.si-amt').value) || 0; var price = parseFloat(r.querySelector('.si-price').value) || 0; total += (amt * price); });
  var totalEl = document.getElementById('si-grand-total'); if(totalEl) totalEl.innerText = total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function getOptions() { var l=[]; if(appData.stock) appData.stock.forEach(x=>l.push(x.name)); if(appData.supplements) appData.supplements.forEach(x=>l.push(x.name)); return l.map(n=>`<option value="${n}">${n}</option>`).join(''); }

// =======================================================
// OTHER FUNCTIONS
// =======================================================
function openAdjustModal() { const categoryOptions = ADJUST_CATEGORIES.map(c => `<option value="${c.code}">${c.label}</option>`).join(''); Swal.fire({ title: 'üõ† ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å', html: `<select id="s4" class="swal2-input w-full border-gray-300 mb-2">${categoryOptions}</select><select id="s1" class="swal2-input w-full border-gray-300 mb-2">${getOptions()}</select><input id="s2" type="number" class="swal2-input w-full mb-2" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÉ‡∏™‡πà‡∏•‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å)"><input id="s3" type="text" class="swal2-input w-full" placeholder="‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">`, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' , preConfirm: () => { const material = document.getElementById('s1').value; const amount = document.getElementById('s2').value; const reason = document.getElementById('s3').value; const categorySelect = document.getElementById('s4'); const category = categorySelect.options[categorySelect.selectedIndex].text; if (!amount) { Swal.showValidationMessage( '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' ); return false; } return { material, amount, reason, category }; } }).then((result) => { if (result.isConfirmed) { showLoading(true); google.script.run.withSuccessHandler(afterAction).feed_recordAdjustment(result.value); } }); }
function openEventModal() { const eventOptions = EVENT_CATEGORIES.map(c => `<option value="${c.code}">${c.label}</option>`).join(''); Swal.fire({ title: 'üì∏ ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', html: `<select id="s3" class="swal2-input w-full border-gray-300 mb-2">${eventOptions}</select><input id="s1" class="swal2-input w-full mb-2" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥"><input type="file" id="s2" class="swal2-file w-full" accept="image/*">`, showCancelButton: true, confirmButtonText: '‡∏™‡πà‡∏á' , preConfirm: () => { const note = document.getElementById('s1').value; const fileInput = document.getElementById('s2'); if (fileInput.files.length === 0) { Swal.showValidationMessage( '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û' ); return false; } return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => { const eventSelect = document.getElementById('s3'); const eventType = eventSelect.options[eventSelect.selectedIndex].text; resolve({ note: note, imageFile: e.target.result, eventType: eventType }); }; reader.onerror = (error) => reject(error); reader.readAsDataURL(fileInput.files[0]); }); } }).then((result) => { if (result.isConfirmed) { showLoading(true); google.script.run.withSuccessHandler(() => { showLoading(false); Swal.fire( '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' , '‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' , 'success'); }).feed_recordEventWithImage(result.value); } }); }
function addNewItemModal(type) { Swal.fire({ title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' , html: `<input id="n1" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠"><input id="n2" type="number" class="swal2-input" placeholder="‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô"><input id="n3" type="password" class="swal2-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (1234)">` , showCancelButton: true }).then(r => { if(r.isConfirmed) { var d = { name: document.getElementById('n1').value, initialStock: document.getElementById('n2').value, minStock:0, unit: '‡∏´‡∏ô‡πà‡∏ß‡∏¢' , pricePerUnit:0, type: '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' , weightPerUnit:30 }; var pass = document.getElementById('n3').value; showLoading(true); var fn = type==='Mat' ? 'feed_addNewMaterial' : 'feed_addNewSupplement'; google.script.run.withSuccessHandler(res => { showLoading(false); if(res.error) Swal.fire('Error', res.error, 'error'); else { Swal.fire('Success', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' ,'success'); loadAllData(); } })[fn](d, pass); } }); }
function loadReport() { showLoading(true); google.script.run.withSuccessHandler(data => { showLoading(false); document.getElementById('report-cost').innerText = data.costThisMonth.toLocaleString(); document.getElementById('report-count').innerText = data.totalMixesThisMonth; var hHtml = ''; (data.recentStockIn.concat(data.recentAdjust)).forEach(h => { var color = h.amount > 0 ? 'text-green-400' : 'text-red-400'; hHtml += `<div class="flex justify-between bg-gray-700 p-2 rounded border border-gray-600"><div><span class="text-gray-200">${h.name}</span><div class="text-xs text-gray-500">${h.date}</div></div><div class="font-bold ${color}">${h.amount}</div></div>`; }); document.getElementById('report-history-list').innerHTML = hHtml || '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>' ; renderCharts(data); }).feed_getFullReportData(); }
function afterAction(res) { showLoading(false); if(res.error) Swal.fire('Error',res.error,'error'); else { appData=res; renderStock(); Swal.fire('Success','','success'); } }
function renderCharts(data) { if(chartInstance1) chartInstance1.destroy(); var ctx1 = document.getElementById('chart-mat').getContext('2d'); chartInstance1 = new Chart(ctx1, { type: 'doughnut', data: { labels: data.chartMat.map(x=>x.label), datasets: [{ data: data.chartMat.map(x=>x.value), backgroundColor: ['#f59e0b','#10b981','#3b82f6','#ef4444','#8b5cf6','#6b7280'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#d1d5db' } } } } }); if(chartInstance2) chartInstance2.destroy(); var ctx2 = document.getElementById('chart-formula').getContext('2d'); chartInstance2 = new Chart(ctx2, { type: 'bar', data: { labels: data.chartFormula.map(x=>x.label), datasets: [{ label: '‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)' , data: data.chartFormula.map(x=>x.value), backgroundColor: '#f59e0b', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { color: '#4a5568' }, ticks: { color: '#d1d5db' } }, y: { grid: { color: '#4a5568' }, ticks: { color: '#d1d5db' } } }, plugins: { legend: { labels: { color: '#d1d5db' } } } } }); }
</script>
</body>
</html>
